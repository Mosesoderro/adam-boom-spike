
        }));
      };

      ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        if (data.candles) {
          const seriesData = data.candles.map(c => ({
            x: new Date(c.epoch * 1000),
            y: [
              parseFloat(c.open),
              parseFloat(c.high),
              parseFloat(c.low),
              parseFloat(c.close)
            ]
          }));
          updateChart(seriesData);
        }
      };

      ws.onerror = (e) => console.error('WebSocket error:', e);
      ws.onclose = () => console.log('WebSocket closed.');
    }

    function updateChart(data) {
      if (!chart) {
        chart = new ApexCharts(document.querySelector('#chart'), {
          chart: {
            type: 'candlestick',
            height: 500,
            background: '#111',
            foreColor: '#0f0'
          },
          series: [{ data }],
          xaxis: {
            type: 'datetime'
          },
          plotOptions: {
            candlestick: {
              colors: {
                upward: '#00f',
                downward: '#f00'
              }
            }
          }
        });
        chart.render();
      } else {
        chart.updateSeries([{ data }]);
      }
    }

    function update() {
      const market = marketSelect.value;
      const granularity = granularitySelect.value;
      connectToDeriv(market, granularity);
    }

    marketSelect.addEventListener('change', update);
    granularitySelect.addEventListener('change', update);

    update();
  </script>
</body>
</html>
